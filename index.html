<link rel="stylesheet" type="text/css" href="apiio_tamper/static/font.css" />
<link rel="stylesheet" type="text/css" href="apiio_tamper/static/ui.css" />
<div class="tamper_conter">
	<ul class="tamper_left_menu">
		<li class="active"><span>防篡改</span></li>
		<li><span>操作日志</span></li>
		<li><span>关于</span></li>
		<li><span>更新历史</span></li>
	</ul>
	<div class="tamper_rigth_body pd20">
		<div class="item_con active" data-type="anti_tamper">
			<div class="tamper_nav_group">
				<span class="active">防篡改管理</span>
			</div>
			<div class="tamper_nav_content">
				<div class="active tamper_nav_item" data-type="anti_tamper_manage">
					<div class="tamper_nav_header">
						<select class="bt-input-text mr5" style="width:180px" name="anti_tamper_site_list"></select>
						<div class="input-group" style="display:inline-block;vertical-align:middle;width:340px;">
							<input type="text" class="bt-input-text mr5" id="tamper_path" style="width:300px" placeholder="请选择需要锁定的目录">
							<span class="input-group-btn">
								<span data-id="tamper_path" class="glyphicon cursor ml5 glyphicon-folder-open"></span>
							</span>
						</div>
						<button class="btn btn-success va0" id="tamper_lock_btn">锁定目录</button>
						<button class="btn btn-danger va0" id="tamper_unlock_btn">解锁目录</button>
					</div>
					<div class="tamper_nav_body">
						<table class="tamper_table table table-hover" id="tamper_locked_table">
							<thead>
								<tr>
									<th>目录路径</th>
									<th width="160px">锁定时间</th>
									<th width="80px">状态</th>
									<th width="160px" style="text-align: right;">操作</th>
								</tr>
							</thead>
							<tbody>
								<tr>
									<td colspan="4" align="center">暂无锁定的目录</td>
								</tr>
							</tbody>
						</table>
						<div class="tamper_page" id="tamper_locked_pagination" style="display: none;"></div>
					</div>
					<ul class="help-info-text c7 mt20">
						<li>防篡改功能使用Linux chattr命令，只对Linux系统有效</li>
						<li>锁定原理：使用chattr -R +i命令设置目录不可修改属性</li>
						<li>解锁原理：使用chattr -R -i命令取消目录不可修改属性</li>
						<li>注意：锁定期间将无法在面板中编辑相关文件，需要先解锁才能操作</li>
					</ul>
				</div>
			</div>
		</div>
		<div class="item_con" data-type="logs">
			<div id="logs_table"></div>
		</div>
		<div class="item_con" data-type="about">
			<div class="about-content" style="padding: 30px;">
				<h2 style="color: #20a53a; margin-bottom: 20px;">apiio_防篡改</h2>
				<div class="about-info" style="line-height: 1.8;">
					<p><strong>插件名称：</strong>apiio_防篡改</p>
					<p><strong>插件版本：</strong>1.1.3</p>
					<p><strong>插件类型：</strong>系统工具</p>
					<p><strong>作者：</strong>我是聋哑人</p>
					<p><strong>发布日期：</strong>2025-3-28</p>
					<p><strong>N：</strong>防止黑客非法修改网页、网站挂马等入侵行为</p>
					<p><strong>QQ群：</strong>29262871</p>
				</div>
			</div>
		</div>
		<div class="item_con" data-type="update_history">
			<div class="update-history-content" style="padding: 30px;">
				<h2 style="color: #20a53a; margin-bottom: 20px;">更新历史</h2>
				<div id="update_history_content" style="line-height: 1.8; font-family: 'Courier New', monospace; white-space: pre-wrap; background: #f8f9fa; padding: 20px; border-radius: 5px; border: 1px solid #e9ecef; max-height: 500px; overflow-y: auto; overflow-x: hidden;">
					正在加载更新历史...
				</div>
			</div>
		</div>
		<div class="loading_mask"></div>
	</div>
</div>
<script src="apiio_tamper/static/jquery.min.js"></script>
<script type="text/javascript">
	var apiio_tamper = {
		plugin_name:'apiio_tamper',
		

		currentPage: 1,
		pageSize: 10,
		totalDirs: 0,
		
		// 初始化
		init:function(){
			var _this = this;
			setTimeout(function(){
				$('.layui-layer-page').width(920).css({
					'top':(document.body.clientHeight-690)/2+'px',
					'left':(document.body.clientWidth-920)/2+'px'
				})
			},1);
			
			$('.tamper_left_menu li').click(function(){
				var _index = $(this).index(), _type = $('.tamper_rigth_body .item_con:eq('+ _index +')').attr('data-type');
				$(this).addClass('active').siblings().removeClass('active');
				$('.tamper_rigth_body .item_con:eq('+ _index +')').addClass('active').siblings().removeClass('active');
				_this.refresh_data_total(_type);
			});
			
			this.return_site_list(function(res){
			var _option = '<option value="">请选择站点</option>',rdata = res.msg;
			for (var i in rdata) {
				_option += '<option value="' + rdata[i] + '">' + i + '</option>'
			}
			$('[name="anti_tamper_site_list"]').html(_option);
		});
			
			this.init_anti_tamper_events();
			
			this.refresh_anti_tamper_data();
		},
		
		get_gl_table_page:function(p){
			if(p == undefined) p=1
			this.render_logs_data({p:p,tojs:'apiio_tamper.get_gl_table_page'});
		},
		
		refresh_data_total:function(type){
			var _this = this;
			switch(type){
				case 'logs':
					this.get_gl_table_page();
				break;
				case 'anti_tamper': 
					this.refresh_anti_tamper_data();
				break;
				case 'about': 
				break;
				case 'update_history': 
					this.load_update_history();
				break;
			}
		},
		
		render_logs_data:function(obj,callback){
			var _this = this;
			if(obj == undefined) obj={p:1}
			this.get_gl_logs({p:obj.p,tojs:obj.tojs},function(res){
				_this.refresh_table_view({
					el:'#logs_table',
					form_id:'logs_table',
					config:[
						{fid:'log',title:'详情'},
						{fid:'addtime',title:'操作时间',width:'150px',style:'text-align: right;'}
					],
					data:res.data,
					page:res.page,
					done:function(res,obj){
					}
				});
			});
		},
		

		
		// 表格视图
		refresh_table_view:function(obj){
			var _thead = '<thead><tr>',_tbody = '',_config = obj.config,_data = obj.data,_event = {},_this = this;
			$(obj.el).css({'height':this.is_defined((typeof obj.height),obj.height,'auto')}).addClass(this.is_defined((typeof obj.height),'fixed-table-view'));
			this.tamper_table_list = this.tamper_table_list || {};
			this.tamper_table_list[obj.form_id] = obj;
			this.tamper_table_list[obj.form_id]['reset']  = function () {
				_this.refresh_table_view(obj)
			}
			for(var i=0;i<_config.length;i++){
				_thead += '<th '+this.is_data_type({name:'width',data:_config[i]}) + this.is_data_type({name:'align',data:_config[i]}) + this.is_data_type({name:'style',data:_config[i]})+'>' + _config[i].title +'</th>';
				if(_config[i]['event']){
					_event[obj.form_id+'_'+_config[i].fid] = {
						name: obj.form_id + '_' + _config[i].fid,
						event: _config[i]['events'] !== undefined?_config[i]['events']:'click',
						method: _config[i]['event']
					};
				}
			}
			_thead += '</tr></thead>';
			_tbody += '<tbody>';
			if(obj.inverted) _data.reverse();
			for(var z=0;z<_data.length;z++){
				_tbody += '<tr data-index="'+ z +'">';
				for(var j=0;j<_config.length;j++){
					var _text = '';
					_tbody += '<td '+ (this.is_data_type({name:'style',data:_config[j]})) +' '+ this.is_data_type({name:'class',data:_config[j]}) +'>';
					if(_config[j].templet !== undefined){
						_text = _config[j].templet(_data[z],z);
						_tbody += _text;
					}else if(_config[j].group !== undefined){
						var _arry = [];
						if(typeof _config[j].group === 'function'){
							_arry = _config[j].group(_data[z],z)
						}else{
							_arry = _config[j].group;
						}
						_tbody += '<span>';
						for(var y=0;y<_arry.length;y++){
							_tbody += '<a class="btlink" '+ this.is_defined((typeof _arry[y]['event']),'data-event="'+obj.form_id+'_'+_config[j].fid+'_'+ y +'"')+
								this.is_data_type({name:'href',data:_config[y]}) +
								this.is_data_type({name:'class',data:_config[y]}) +
								this.is_data_type({name:'target',data:_config[y]}) +'>'+ _arry[y].title +'</a>';
							if((y+1) !== _arry.length) _tbody += '&nbsp;|&nbsp;';
							if(_arry[y]['event'] && !_event[obj.form_id+'_'+_config[j].fid+'_' + y]){
								_event[obj.form_id+'_'+_config[j].fid+'_' + y] = {
									name: obj.form_id+'_'+_config[j].fid+'_' + y,
									event: _arry[y]['events'] !== undefined?_arry[y]['events']:'click',
									method: _arry[y]['event']
								};
							}
						}
						_tbody += '</span>';
					}else{
						_text = _data[z][_config[j].fid];
						if(_text !== ''){
							_tbody += '<span>';
							switch(_config[j].type){
								case 'text':
									_tbody += '<span '+ this.is_defined((typeof _config[j].event),'data-event="'+obj.form_id+'_'+_config[j].fid+'"')+'>'+ _text +'</span>';
								break;
								case 'link':
									_tbody += '<a class="btlink" '+ this.is_defined((typeof _config[j].event),'data-event="'+obj.form_id+'_'+_config[j].fid+'"') + this.is_data_type({name:'href',data:_config[j],val:_config[j]['href']?_text:false}) + this.is_data_type({name:'class',data:_config[j]}) + this.is_data_type({name:'target',data:_config[j]}) +'>'+ _text +'</a>';
								break;
								case 'checkbox':
									_tbody += '<input type="checkbox" class="tamper_td_checkbox" '+(_data[z][_config[j].fid]?'checked':'') +' '+this.is_defined((typeof _config[j].event),'data-event="'+obj.form_id+'_'+_config[j].fid+'"')+' />';
								break;
								case 'btswitch':
									_tbody += '<input class="btswitch btswitch-ios" id="close_'+ _config[j].fid+'_'+ obj.form_id +'_'+ z +'" '+(_data[z][_config[j].fid]?'checked':'') +' type="checkbox">'+
										'<label class="btswitch-btn" for="close_'+ _config[j].fid +'_'+ obj.form_id +'_'+ z +'" '+ this.is_defined((typeof _config[j].event),'data-event="'+obj.form_id+'_'+_config[j].fid+'"') +'></label>';
								break;
								default:
									_tbody += '<span '+this.is_defined((typeof _config[j].event),'data-event="'+obj.form_id+'_'+_config[j].fid+'"')+'>'+ _text +'</span>';
								break;
							}
							_tbody += '</span>';
						}else{
							_tbody += '<span>--</span>';
						}
					}
					_tbody += '</td>';
				}
				_tbody += '</tr>';
			}
			if(_data.length ===  0){
				_tbody += '<tr><td colspan="'+ _config.length +'" align="center">'+ this.is_defined((typeof obj.tips),obj.tips,'当前数据为空') +'</td></tr>';
			}
			_tbody += '</tbody>';
			$(obj.el).html('<table class="'+ this.is_defined((typeof obj.class),obj.class,'tamper_table table table-hover') +'">'+ _thead + _tbody +'</table>');
			if(obj.page){
				if($(obj.el).next().length == 0){
					$(obj.el).after('<div class="tamper_page">'+ obj.page +'</div>');
				}else{
					$(obj.el).next().html(obj.page);
				}
			}
			this.bind_evnet_group(obj,_event);
			setTimeout(function(){
				if(obj.done) obj.done(obj.data,obj);
			},100);
			if(obj.height !== undefined){
				$(obj.el+' table').before('<table class="'+ _this.is_defined((typeof obj.class),obj.class,'tamper_table table table-hover fixed-table-thead') +'">'+ _thead +'</table>')
				$(obj.el+ ' .fixed-table-thead').next().addClass('fixed-table');
				setTimeout(function(){
					$(obj.el+' .fixed-table thead th').each(function(index,el){
						var _offsetWidth = $(this)[0].offsetWidth - 20;
						$(obj.el +' .fixed-table-thead thead th').eq(index).html($(obj.el +' thead th').eq(index).text() +'<div class="tamper-fht-cell" style="width:'+ _offsetWidth +'px">');
					});
				},100);
				if($(obj.el+ ' .fixed-table')[0].offsetHeight > parseFloat(obj.height)){
					$(obj.el+ ' .fixed-table-thead').addClass('fixed-table-shadow');
				}
				$(obj.el+ ' .fixed-table-thead').css('top',$(obj.el).scrollTop())
				$(obj.el).scroll(function(){
					$(obj.el+ ' .fixed-table-thead').css('top',$(this).scrollTop());
				});
			}
		},
		
		is_defined:function(is_val,num1,num2){
			return is_val !== 'undefined'?(num1 === undefined?is_val:num1):(num2 === undefined?'':num2);
		},
		
		// 判断数据类型
		is_data_type:function(obj){
			if(obj.data === undefined){
				return 'href="javascript:;" ';
			}
			if(obj.data[obj.name] !== undefined){
				return obj.name +'="'+ obj.data[obj.name]+'" ';
			}
			if(obj.name == 'href'){
				if(!obj.val){
					return 'href="javascript:;" ';
				}else{
					return 'href="'+ obj.val +'" ';
				}
			}
			return '';
		},
		
		bind_evnet_group:function(obj,events){
			for(var i in events){
				(function(i){
					$(obj.el +' [data-event='+events[i].name+']').bind(events[i].event,function(e){
						var _index = parseInt($(this).parent().parent().parent().attr('data-index')),
							_data = obj.data[_index];
						events[i].method(_data,_index,e,$(this));
					});
				})(i)
			}
		},

		http: function (obj) {
            var loadT = '';
            if (obj.load == undefined) obj.load = 0;
            if (obj.url == undefined) {
                if (obj.plugin_name === undefined && this.plugin_name !== undefined) obj.plugin_name = this.plugin_name
                if (!obj.plugin_name || !obj.method) {
                    layer.msg('插件类名称，或插件方法名称缺失!', {icon: 2 });
                    return false;
                }
            }
            if (obj.load === 0 || obj.tips != '') {
                loadT = layer.msg(obj.tips, {icon: 16,time: 0, shade: 0.3});
            } else if (obj.load === 1 || (obj.tips == undefined && obj.load == undefined)) {
                loadT = layer.load();
            }
            $.ajax({
                type: obj.type===undefined?'POST':obj.type,
                url: obj.url != undefined ? obj.url : ('/plugin?action=a&name=' + obj.plugin_name + '&s=' + obj.method),
                data: obj.data || {},
                timeout: obj.timeout || 99999999,
                complete: function (res) {
                    if (obj.load === 0 || obj.load === 1) layer.close(loadT);
                },
                success: function (rdata) {
                    if (obj.check) {
                        obj.success(rdata);
                        return
                    }
                    if (typeof rdata.status !== 'undefined' && rdata.status === false) {
                        layer.msg(rdata.msg, {icon: 2});
                        return false;
                    }
                    obj.success(rdata);
                },
                error: function (ex) {
                    if (!obj.error) {
                        obj.msg || obj.msg == undefined ? layer.msg('请求过程发现错误!', {icon: 2}) : '';
                        return;
                    }
                    return obj.error(ex);
                }
            });
        },

		return_site_list:function(callback){
			this.http({
				tips:'正在获取站点列表，请稍后...',
				method:'return_site',
				success:function(res){
					if(callback) callback(res);
				}
			});
		},
		
		get_gl_logs:function(obj,callback){
			this.http({
				tips:'正在获取操作日志，请稍后...',
				method:'get_gl_logs',
				data:{
					p:obj.p,
					tojs:obj.tojs
				},
				success:function(res){
					if(callback) callback(res);
				}
			});
		},
		
		get_locked_dirs:function(callback){
			this.http({
				tips:'正在获取已锁定目录列表，请稍后...',
				method:'get_locked_dirs',
				success:function(res){
					if(callback) callback(res);
				}
			});
		},
		
		lock_dir:function(data, callback){
			this.http({
				tips:'正在锁定目录，请稍后...',
				method:'lock_dir',
				data: data,
				success:function(res){
					if(callback) callback(res);
				}
			});
		},
		
		unlock_dir:function(data, callback){
			this.http({
				tips:'正在解锁目录，请稍后...',
				method:'unlock_dir',
				data: data,
				success:function(res){
					if(callback) callback(res);
				}
			});
		},
		
		render_locked_dirs:function(page){
			var _this = this;
			if(page !== undefined) {
				_this.currentPage = page;
			}
			
			_this.get_locked_dirs(function(res){
				if(res.status === false){
					layer.msg(res.msg, {icon:2});
					$('#tamper_locked_table tbody').html('<tr><td colspan="4" align="center">获取锁定目录列表失败</td></tr>');
					$('#tamper_locked_pagination').hide();
					return;
				}
				
				var dirList = res.msg || [];
				_this.totalDirs = dirList.length;
				
				// 计算分页数据
				var startIndex = (_this.currentPage - 1) * _this.pageSize;
				var endIndex = Math.min(startIndex + _this.pageSize, _this.totalDirs);
				var currentPageData = dirList.slice(startIndex, endIndex);
				
				var tbodyHtml = '';
				
				if(currentPageData.length === 0){
					tbodyHtml = '<tr><td colspan="4" align="center">暂无锁定的目录</td></tr>';
				} else {
					for(var i = 0; i < currentPageData.length; i++){
						var row = currentPageData[i];
						var status = '已锁定';
						if(row.config && row.config.enabled === false) {
							status = '已解锁';
						}
						
						tbodyHtml += '<tr>';
						tbodyHtml += '<td>' + row.path + '</td>';
						tbodyHtml += '<td>' + (row.lock_time || '--') + '</td>';
						tbodyHtml += '<td>' + status + '</td>';
						tbodyHtml += '<td style="text-align: right;">';
						tbodyHtml += '<a class="btlink" href="javascript:;" onclick="apiio_tamper.show_tamper_config(' + JSON.stringify(row).replace(/"/g, '&quot;') + ', ' + i + ')">配置</a>';
						tbodyHtml += '&nbsp;|&nbsp;';
						tbodyHtml += '<a class="btlink" href="javascript:;" onclick="apiio_tamper.unlockDirConfirm(\'' + row.path.replace(/'/g, "\\'") + '\')">解锁</a>';
						tbodyHtml += '</td>';
						tbodyHtml += '</tr>';
					}
				}
				
				$('#tamper_locked_table tbody').html(tbodyHtml);
				
				_this.renderPagination();
			});
		},

		renderPagination:function(){
			var _this = this;
			var totalPages = Math.ceil(_this.totalDirs / _this.pageSize);
			
			var paginationHtml = '';
			
			if(_this.currentPage > 1) {
				paginationHtml += '<a href="javascript:;" onclick="apiio_tamper.render_locked_dirs(' + (_this.currentPage - 1) + ')" class="page-item">上一页</a>';
			} else {
				paginationHtml += '<span class="page-item disabled">上一页</span>';
			}
			
			if(totalPages > 0) {
				var startPage = Math.max(1, _this.currentPage - 2);
				var endPage = Math.min(totalPages, startPage + 4);
				
				for(var i = startPage; i <= endPage; i++) {
					if(i === _this.currentPage) {
						paginationHtml += '<span class="page-item active">' + i + '</span>';
					} else {
						paginationHtml += '<a href="javascript:;" onclick="apiio_tamper.render_locked_dirs(' + i + ')" class="page-item">' + i + '</a>';
					}
				}
			} else {
				paginationHtml += '<span class="page-item active">1</span>';
			}
			
			if(_this.currentPage < totalPages) {
				paginationHtml += '<a href="javascript:;" onclick="apiio_tamper.render_locked_dirs(' + (_this.currentPage + 1) + ')" class="page-item">下一页</a>';
			} else {
				paginationHtml += '<span class="page-item disabled">下一页</span>';
			}
			
			paginationHtml += '<span class="page-info">共 ' + _this.totalDirs + ' 条记录，每页 ' + _this.pageSize + ' 条</span>';
			
			$('#tamper_locked_pagination').html(paginationHtml).show();
		},
		
		unlockDirConfirm:function(path){
			var _this = this;
			layer.confirm('确定要解锁该目录吗？解锁后，目录将可以被修改。', {
				btn: ['确定','取消'], 
				icon: 3, 
				title: '解锁确认'
			}, function(index){
				layer.close(index);
				_this.unlock_dir({path:path},function(unlock_res){
					layer.msg(unlock_res.msg, {icon: unlock_res.status ? 1 : 2});
					if(unlock_res.status){
						_this.render_locked_dirs(_this.currentPage);
					}
				});
			});
		},
		
		init_anti_tamper_events:function(){
			var _this = this;
			
			$('[name="anti_tamper_site_list"]').off('change').on('change', function(){
				$('#tamper_path').val($(this).val());
			});
			
			$('span[data-id="tamper_path"]').off('click').on('click', function(){
				bt.select_path('tamper_path');
			});
			
			$('#tamper_lock_btn').off('click').on('click', function(){
				var path = $('#tamper_path').val();
				if(!path){
					layer.msg('请选择需要锁定的目录', {icon: 2});
					return false;
				}
				
				layer.confirm('确定要锁定该目录吗？锁定后，目录下所有文件将无法修改、删除或新增文件，需要先解锁才能操作！', {
					btn: ['确定','取消'], 
					icon: 3, 
					title: '锁定确认'
				}, function(index){
					layer.close(index);
					_this.lock_dir({path: path}, function(res){
						layer.msg(res.msg, {icon: res.status ? 1 : 2});
						if(res.status){
							$('#tamper_path').val('');
							_this.render_locked_dirs();
						}
					});
				});
			});
			
			$('#tamper_unlock_btn').off('click').on('click', function(){
				var path = $('#tamper_path').val();
				if(!path){
					layer.msg('请选择需要解锁的目录', {icon: 2});
					return false;
				}
				
				layer.confirm('确定要解锁该目录吗？解锁后，目录将可以被修改。', {
					btn: ['确定','取消'], 
					icon: 3, 
					title: '解锁确认'
				}, function(index){
					layer.close(index);
					_this.unlock_dir({path: path}, function(res){
						layer.msg(res.msg, {icon: res.status ? 1 : 2});
						if(res.status){
							$('#tamper_path').val('');
							_this.render_locked_dirs();
						}
					});
				});
			});
		},
		
		// 刷新防篡改数据
		refresh_anti_tamper_data:function(){
			var _this = this;
			_this.render_locked_dirs();
		},
		
		// 显示防篡改配置面板
		show_tamper_config: function(row, index) {
			var _this = this;
			var path = row.path;
			
			_this.http({
				tips: '正在获取最新配置数据...',
				method: 'get_tamper_config',
				data: {path: path},
				success: function(config_res) {
					if(config_res.status && config_res.msg && config_res.msg.config) {
						row.config = config_res.msg.config;
					}
					
					if(!row.config) {
						row.config = {
							enabled: true,
							protected_exts: [],
							dir_whitelist: [],
							file_whitelist: []
						};
					}
					
					layer.open({
						type: 1,
						title: '防篡改配置 - ' + path,
						area: ['650px', '550px'],
						closeBtn: 2,
						shadeClose: false,
						content: '<div class="pd15">\
							<div class="bt-form">\
								<div class="line">\
									<span class="tname">防篡改状态</span>\
									<div class="info-r">\
										<div class="switch-wrapper">\
											<div class="switch" style="display:inline-block">\
												<input class="btswitch btswitch-ios" id="tamper_switch" type="checkbox" '+ (row.config.enabled ? 'checked' : '') +'>\
												<label class="btswitch-btn" for="tamper_switch"></label>\
											</div>\
										</div>\
									</div>\
								</div>\
								<div class="line">\
									<div class="tabs">\
										<div class="tab-item active" data-tab="protected_exts">受保护文件类型</div>\
										<div class="tab-item" data-tab="dir_whitelist">目录白名单</div>\
										<div class="tab-item" data-tab="file_whitelist">文件白名单</div>\
									</div>\
								</div>\
								<div class="tab-content">\
									<div class="tab-pane active" id="protected_exts">\
										<div class="line">\
											<span class="tname">受保护文件类型</span>\
											<div class="info-r">\
												<input class="bt-input-text mr5" type="text" name="protected_ext" placeholder="输入文件扩展名，如php" style="width:300px">\
												<button class="btn btn-success btn-sm va0" id="add_protected_ext">添加</button>\
												<div class="help-info-text c7 mt5" style="color:#f00;">提示：当列表为空时，将统一锁定目录下的所有文件。如需锁定特定类型的文件，请添加扩展名。</div>\
											</div>\
										</div>\
										<div class="line">\
											<div class="divtable">\
												<table class="table table-hover">\
													<thead>\
														<tr>\
															<th>文件扩展名</th>\
															<th style="text-align:right">操作</th>\
														</tr>\
													</thead>\
													<tbody id="protected_exts_tbody"></tbody>\
												</table>\
											</div>\
										</div>\
									</div>\
									<div class="tab-pane" id="dir_whitelist">\
										<div class="line">\
											<span class="tname">目录白名单</span>\
											<div class="info-r">\
												<input class="bt-input-text mr5" type="text" id="dir_whitelist_input" placeholder="输入目录路径，如/upload" style="width:300px">\
												<button class="btn btn-success btn-sm va0" id="add_dir_whitelist">添加</button>\
												<div class="help-info-text c7 mt5">提示：白名单中的目录及其子目录将不会被锁定。</div>\
											</div>\
										</div>\
										<div class="line">\
											<div class="divtable">\
												<table class="table table-hover">\
													<thead>\
														<tr>\
															<th>目录路径</th>\
															<th style="text-align:right">操作</th>\
														</tr>\
													</thead>\
													<tbody id="dir_whitelist_tbody"></tbody>\
												</table>\
											</div>\
										</div>\
									</div>\
									<div class="tab-pane" id="file_whitelist">\
										<div class="line">\
											<span class="tname">文件白名单</span>\
											<div class="info-r">\
												<input class="bt-input-text mr5" type="text" id="file_whitelist_input" placeholder="输入文件路径，如/index.php" style="width:300px">\
												<button class="btn btn-success btn-sm va0" id="add_file_whitelist">添加</button>\
												<div class="help-info-text c7 mt5">提示：白名单中的文件将不会被锁定。</div>\
											</div>\
										</div>\
										<div class="line">\
											<div class="divtable">\
												<table class="table table-hover">\
													<thead>\
														<tr>\
															<th>文件路径</th>\
															<th style="text-align:right">操作</th>\
														</tr>\
													</thead>\
													<tbody id="file_whitelist_tbody"></tbody>\
												</table>\
											</div>\
										</div>\
									</div>\
								</div>\
							</div>\
						</div>',
						success: function(layero, index) {
							// 选项卡切换
							$('.tab-item').click(function() {
								var tab = $(this).data('tab');
								$('.tab-item').removeClass('active');
								$(this).addClass('active');
								$('.tab-pane').removeClass('active');
								$('#' + tab).addClass('active');
							});
							
									function renderProtectedExts() {
										apiio_tamper.renderTable(row.config.protected_exts, 'protected_exts_tbody', 'protected_exts', path);
									}
									
									function renderDirWhitelist() {
										apiio_tamper.renderTable(row.config.dir_whitelist, 'dir_whitelist_tbody', 'dir_whitelist', path);
									}
									
									function renderFileWhitelist() {
										apiio_tamper.renderTable(row.config.file_whitelist, 'file_whitelist_tbody', 'file_whitelist', path);
									}
							
							renderProtectedExts();
							renderDirWhitelist();
							renderFileWhitelist();
							
									$('#tamper_switch').change(function() {
										var enabled = $(this).prop('checked');
										var switchElement = $(this); // 保存this引用
										_this.update_tamper_config({
											path: path,
											config: {
												enabled: enabled
											}
										}, function(res) {
											layer.msg(res.msg, {icon: res.status ? 1 : 2});
											if(res.status) {
												row.config.enabled = enabled;
												_this.render_locked_dirs();
											} else {
												// 恢复开关状态
												switchElement.prop('checked', !enabled);
											}
										});
									});
							
							function addItem(inputSelector, dataKey, renderFunction, validationFn) {
								var value = $(inputSelector).val().trim();
								if(!value) {
									layer.msg('请输入内容', {icon: 2});
									return;
								}
								
								if(validationFn) {
									value = validationFn(value);
								}
								
								_this.get_tamper_config({path: path}, function(config_res) {
									if(config_res.status) {
										var latest_config = config_res.msg.config || {};
										latest_config[dataKey] = latest_config[dataKey] || [];
										
										// 检查是否已存在
										if(latest_config[dataKey].indexOf(value) > -1) {
											layer.msg('该项目已存在', {icon: 2});
											return;
										}
										
										row.config[dataKey] = latest_config[dataKey];
										row.config[dataKey].push(value);
										
										var configUpdate = {};
										configUpdate[dataKey] = row.config[dataKey];
										
										_this.update_tamper_config({
											path: path,
											config: configUpdate
										}, function(res) {
											layer.msg(res.msg, {icon: res.status ? 1 : 2});
											if(res.status) {
												$(inputSelector).val('');
												renderFunction();
											}
										});
									} else {
										layer.msg('获取最新配置失败: ' + config_res.msg, {icon: 2});
									}
								});
							}
							
							// 添加受保护文件类型
							$('#add_protected_ext').click(function() {
								addItem('input[name="protected_ext"]', 'protected_exts', renderProtectedExts, function(value) {
									if(value.startsWith('.')) {
										return value.substring(1);
									}
									return value;
								});
							});
							
							// 添加目录白名单
							$('#add_dir_whitelist').click(function() {
								addItem('#dir_whitelist_input', 'dir_whitelist', renderDirWhitelist, function(value) {

									if(!value.startsWith('/')) {
										value = '/' + value;
									}
									
									if(value.endsWith('/') && value !== '/') {
										value = value.substring(0, value.length - 1);
									}
									return value;
								});
							});
							
							// 添加文件白名单
							$('#add_file_whitelist').click(function() {
								addItem('#file_whitelist_input', 'file_whitelist', renderFileWhitelist, function(value) {
									// 确保以/开头
									if(!value.startsWith('/')) {
										value = '/' + value;
									}
									return value;
								});
							});
						}
					});
				}
			});
		},
		
		// 更新防篡改配置
		update_tamper_config: function(data, callback) {
			var params = {};
			params.path = data.path;
			
			if(data.config) {
				if(data.config.enabled !== undefined) {
					params.enabled = data.config.enabled;
				}
				
				if(data.config.protected_exts) {
					var protected_exts = Array.isArray(data.config.protected_exts) ? data.config.protected_exts : [];
					params.protected_exts = JSON.stringify(protected_exts);
				}
				
				if(data.config.dir_whitelist) {
					var dir_whitelist = Array.isArray(data.config.dir_whitelist) ? data.config.dir_whitelist : [];
					params.dir_whitelist = JSON.stringify(dir_whitelist);
				}
				
				if(data.config.file_whitelist) {
					var file_whitelist = Array.isArray(data.config.file_whitelist) ? data.config.file_whitelist : [];
					params.file_whitelist = JSON.stringify(file_whitelist);
				}
			}
			
			this.http({
				tips: '正在更新防篡改配置，请稍后...',
				method: 'update_tamper_config',
				data: params,
				success: function(res) {
					if(callback) callback(res);
				}
			});
		},
		
		removeItem: function(path, item, itemType, methodName, containerId, renderFunction) {
			var _this = this;
			var confirmMsg = '确定要从' + 
				(itemType === 'protected_exts' ? '受保护列表中移除 ' + item + ' 文件类型吗？' : 
				 itemType === 'dir_whitelist' ? '白名单中移除目录 ' + item + ' 吗？' : 
				 '白名单中移除文件 ' + item + ' 吗？');
			
			layer.confirm(confirmMsg, {
				btn: ['确定','取消'], 
				icon: 3, 
				title: '移除确认'
			}, function(index) {
				layer.close(index);
				_this.http({
					tips: '正在移除...',
					method: methodName,
				data: (function() {
										var dataObj = {path: path};
										var fieldMap = {
											'protected_exts': 'ext',
											'dir_whitelist': 'dir',
											'file_whitelist': 'file'
										};
										dataObj[fieldMap[itemType]] = item;
										return dataObj;
									})(),
					success: function(res) {
						layer.msg(res.msg, {icon: res.status ? 1 : 2});
						if(res.status) {
							_this.get_tamper_config({path: path}, function(config_res) {
								if(config_res.status) {
									var config = config_res.msg.config || {};
									config[itemType] = config[itemType] || [];
									
									renderFunction(config[itemType], containerId, itemType, path);
								}
							});
						}
					}
				});
			});
		},
		

		remove_protected_ext: function(path, ext) {
			this.removeItem(path, ext, 'protected_exts', 'remove_protected_ext', 'protected_exts_tbody', this.renderTable);
		},
		

		remove_dir_whitelist: function(path, dir) {
			this.removeItem(path, dir, 'dir_whitelist', 'remove_dir_whitelist', 'dir_whitelist_tbody', this.renderTable);
		},
		

		remove_file_whitelist: function(path, file) {
			this.removeItem(path, file, 'file_whitelist', 'remove_file_whitelist', 'file_whitelist_tbody', this.renderTable);
		},
		

		get_tamper_config: function(data, callback) {
			this.http({
				tips: '正在获取防篡改配置...',
				method: 'get_tamper_config',
				data: data,
				success: function(res) {
					if(callback) callback(res);
				}
			});
		},
		

		renderTable: function(data, containerId, itemType, path) {
			var html = '';
			if(data.length === 0) {
				html = '<tr><td colspan="2" style="text-align:center;color:#999;">暂无数据</td></tr>';
			} else {
				for(var i = 0; i < data.length; i++) {
					var item = data[i];
					var removeFunction = '';
						if(itemType === 'protected_exts') {
							removeFunction = 'remove_protected_ext';
						} else if(itemType === 'dir_whitelist') {
							removeFunction = 'remove_dir_whitelist';
						} else if(itemType === 'file_whitelist') {
							removeFunction = 'remove_file_whitelist';
						}
					html += '<tr>\
						<td>' + item + '</td>\
						<td style="text-align:right">\
							<a class="btlink" onclick="apiio_tamper.' + removeFunction + '(\'' + path + '\', \'' + item + '\')">删除</a>\
						</td>\
					</tr>';
				}
			}
			$('#' + containerId).html(html);
		},
		
		// 加载更新历史
		load_update_history: function() {
			var _this = this;
			
			$.ajax({
				url: '/plugin?action=a&name=' + this.plugin_name + '&s=get_update_history',
				type: 'GET',
				dataType: 'json',
				success: function(res) {
					if(res.status === true) {
						$('#update_history_content').html(res.msg);
					} else {
						$('#update_history_content').html('<div style="color: #d9534f;">加载更新历史失败: ' + res.msg + '</div>');
					}
				},
				error: function(xhr, status, error) {
					$('#update_history_content').html('<div style="color: #d9534f;">加载更新历史失败: ' + error + '</div>');
				}
			});
		}
	}
	apiio_tamper.init();
</script>